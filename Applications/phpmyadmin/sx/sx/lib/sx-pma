#!/bin/bash
source $SX_LIBDIR/sx-php

# Display pma information
function pmaInformation {
    phpInformation $1 
}

# function executed when build hook is called
function pmaBuild {
    genericHeader
    echoNotVerbose "container $HOSTNAME executing Pma BUILD"
    echoVerbose "+====================================================="
    echoVerbose "| Container $HOSTNAME executing Pma BUILD"
    echoVerbose "| "
    pmaInformation "| "
    echoDebug `env`
    echoVerbose "+====================================================="
    doPmaBuild
    if [[ -x $MYS2I_DEST/assemble ]]; then
        echoVerbose "Build source code found at $MYS2I_DEST/assemble"
        testAndRunSourceCodeScript "assemble" 
    else
        echoVerbose "No Build source code found at $MYS2I_DEST/assemble"
    fi
    exit 0;
}

# function performing Pma build actions
function doPmaBuild {
    doGenericBuild
    echoNotVerbose "Build Pma"
    echoVerbose ""
    echoVerbose "+====================================================="
    echoVerbose "| Build Pma"
    echoVerbose "+====================================================="
}

# function executed when post-build hook is called
function pmaPostBuild {
    genericHeader
    echoNotVerbose "container $HOSTNAME executing Pma POST-BUILD"
    echoVerbose "+====================================================="
    echoVerbose "| Container $HOSTNAME executing Pma POST-BUILD"
    echoVerbose "| "
    pmaInformation "| "
    echoDebug `env`
    echoVerbose "+====================================================="
    doPmaPostBuild
    if [[ -x $MYS2I_DEST/assemble ]]; then
        echoVerbose "PostBuild source code found at $MYS2I_DEST/post-build"
        testAndRunSourceCodeScript "post-build" 
    else
        echoVerbose "No PostBuild source code found at $MYS2I_DEST/post-build"
    fi
    exit 0;
}

# function performing Pma post-build actions
function doPmaPostBuild {
    doGenericPostBuild
    echoNotVerbose "PostBuild Pma"
    echoVerbose ""
    echoVerbose "+====================================================="
    echoVerbose "| PostBuild Pma"
    echoVerbose "+====================================================="
}

# function executed when pre-deploy hook is called
function pmaPreDeploy {
    genericHeader
    echoNotVerbose "container $HOSTNAME executing Pma PRE-DEPLOY"
    echoVerbose "+====================================================="
    echoVerbose "| Container $HOSTNAME executing Pma PRE-DEPLOY"
    echoVerbose "| "
    pmaInformation "| "
    echoDebug `env`
    echoVerbose "+====================================================="
    doPmaPreDeploy
    if [[ -x $MYS2I_DEST/pre-deploy ]]; then
        echoVerbose "PreDeploy source code found at $MYS2I_DEST/pre-deploy"
        testAndRunSourceCodeScript "pre-deploy" 
    else
        echoVerbose "No PreDeploy source code found at $MYS2I_DEST/pre-deploy"
    fi
    exit 0;
}

# function performing Pma pre-deploy actions
function doPmaPreDeploy {
    doGenericPreDeploy
    echoNotVerbose "PreDeploy Pma"
    echoVerbose ""
    echoVerbose "+====================================================="
    echoVerbose "| PreDeploy Pma"
    echoVerbose "+====================================================="
    echoVerbose "Create log directory $LOG_PATH"
    touch $LOG_PATH/access.log
}

# function executed when post-deploy hook is called
function pmaPostDeploy {
    genericHeader
    echoNotVerbose "container $HOSTNAME executing Pma POST-DEPLOY"
    echoVerbose "+====================================================="
    echoVerbose "| Container $HOSTNAME executing Pma POST-DEPLOY"
    echoVerbose "| "
    pmaInformation "| "
    echoDebug `env`
    echoVerbose "+====================================================="
    doPmaPostDeploy
    if [[ -x $MYS2I_DEST/post-deploy ]]; then
        echoVerbose "PostDeploy source code found at $MYS2I_DEST/post-deploy"
        testAndRunSourceCodeScript "post-deploy" 
    else
        echoVerbose "No PostDeploy source code found at $MYS2I_DEST/post-deploy"
    fi
    exit 0;
}

# function performing Pma post-deploy actions
function doPmaPostDeploy {
    doGenericPostDeploy
    echoNotVerbose "PostDeploy Pma"
    echoVerbose ""
    echoVerbose "+====================================================="
    echoVerbose "| PostDeploy Pma"
    echoVerbose "+====================================================="
}

# function executed on container startup
function pmaRun {
    genericHeader
    echoNotVerbose "container $HOSTNAME executing Pma RUN"
    echoVerbose "+====================================================="
    echoVerbose "| Container $HOSTNAME executing Pma RUN"
    echoVerbose "| "
    pmaInformation "| "
    echoDebug `env`
    echoVerbose "+====================================================="
    if [[ -x $MYS2I_DEST/run ]]; then
        echoVerbose "Run source code found at $MYS2I_DEST/run"
        testAndRunSourceCodeScript "run" 
    else
        echoVerbose "No Run source code found at $MYS2I_DEST/run"
        echoVerbose "Executing default Pma run action"
        doPmaRun
    fi
}

# function performing Pma run actions
function doPmaRun {
    echoNotVerbose "Run Pma"
    echoVerbose ""
    echoVerbose "+====================================================="
    echoVerbose "| Run Pma"
    echoVerbose "+====================================================="
    startPhpService
}

# Display liveness status
function pmaIsLive {
    apacheIsLive
}

# Display readyness status
function pmaIsReady {
    apacheIsReady
}

#!/bin/bash

IMAGE_TAG=docker.io/${NAMESPACE}/$2:$3
IMAGE_QUAYTAG=quay.io/${NAMESPACE}/$4:$3
echo "========> PUBLISH Container image $IMAGE_TAG"
if [ -f /tmp/istested_$4 ] ; then
    RESULT=$(docker push $IMAGE_TAG)
    if [[ $? = "0" ]]; then
        echo "========> PUBLISHED Container image $IMAGE_TAG"
        if [ "$SX_DEBUG" = true ] ; then
            echo $RESULT
        fi
        echo "========> PUBLISH Container image $IMAGE_QUAYTAG"
        docker tag $IMAGE_TAG $IMAGE_QUAYTAG &>/dev/null
        RESULT=$(docker push $IMAGE_QUAYTAG)
        echo "========> PUBLISHED Container image $IMAGE_QUAYTAG"
        if [ "$SX_DEBUG" = true ] ; then
            echo $RESULT
        fi
        exit 0;
    else
        echo "!!!!!!!!> Could not publish container image $IMAGE_TAG"
        if [ "$SX_DEBUG" = true ] ; then
            echo $RESULT
        fi
        if [[ "$ISFATAL" = "true" ]]; then
            exit 31;
        else
            exit 0;
        fi
    fi
else
    echo "--------> PUBLISHING Container image $IMAGE_TAG skipped because already tested"
    exit 0;
fi